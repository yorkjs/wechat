import*as e from"@yorkjs/url";let t;function n(){return t}function i(e){return t.storage.get(`@@wechat@@_${e}`)}function r(e,n){t.storage.set(`@@wechat@@_${e}`,n)}function s(e){t.storage.remove(`@@wechat@@_${e}`)}const a=navigator.userAgent;/iphone|ipad/i.test(a);const o=/android/i.test(a);let c=!1;function u(e,t,n,i,r){let s=`appid=${i}&redirect_uri=${encodeURIComponent(t)}&response_type=code&scope=${n}&state=${e}`;r&&(s+=`&component_appid=${r}`),c=!0,location.href=`https://open.weixin.qq.com/connect/oauth2/authorize?${s}#wechat_redirect`}function p(t,n){const i=e.parseUrl(t);if(i.search){const t=e.parseQuery(i.search.slice(1));if(t.state&&t.code){delete t.state,delete t.code;const n=e.stringifyQuery(t);i.search=n?`?${n}`:""}}return n&&n(i),e.stringifyUrl(i)}window.addEventListener("unload",(function(e){c&&r("auth_page_unload_timestamp",n().getTimestamp())}));const m={};function l(e,t){const r=n().getTimestamp();if(e<=0)return!1;const s=r-e<t;let a=!1;const o=i("auth_page_unload_timestamp");return o&&(a=r-o<t),s||a}const f=function(e){t=e},d=function(e,t,i,s){const a=n().getTimestamp(),o=encodeURIComponent(`${e}@${a}`);r(e,JSON.stringify({state:e,timestamp:a})),u(o,t,"snsapi_userinfo",i,s)},g=function(e,t,i,s){const a=n().getTimestamp(),o=encodeURIComponent(`${e}@${a}`);r(e,JSON.stringify({state:e,timestamp:a})),u(o,t,"snsapi_base",i,s)},h=function(e){s("auth_page_unload_timestamp"),s(e)},_=function(t,n){const r=function(t){const n={},i=e.parseUrl(t);if(!i.search)return n;const r=e.parseQuery(i.search.slice(1));if(r.state&&r.code){const[e,t]=r.state.split("@");n.code=r.code,n.state=e,n.timestamp=+t}return n}(t),{state:s,code:a,timestamp:o}=r;if(s&&a&&o){if(!n)return r;const{once:e}=n;if(!function(e,t){const{expireSeconds:n,once:i}=t,{state:r,timestamp:s}=e;return!(!r||!s||n&&!l(s,1e3*n)||i&&m[r])}(r,n))return{};if(!function(e,t){let n=i(e)||{};if(n&&"string"==typeof n)try{n=JSON.parse(n)}catch(e){n={}}const{expireSeconds:r,once:s}=t,{state:a,timestamp:o}=n;return!(!a||!o||r&&!l(o,1e3*r)||s&&m[a])}(s,n))return{};if(!function(e){const{state:t,timestamp:n}=e;if(t&&n){let e=i(t)||{};if(e&&"string"==typeof e)try{e=JSON.parse(e)}catch(t){e={}}return e.state===t&&e.timestamp===n}return!1}(r))return{};e&&(m[s]=!0)}return r},S=function(e,t,n,i,r=!1){return new Promise((function(s,a){e.config({debug:r,appId:t.appId,timestamp:t.timestamp,nonceStr:t.nonceStr,signature:t.signature,jsApiList:n}),e.ready((function(){e.checkJsApi({jsApiList:n,success(t){const n=t.checkResult;n.updateAppMessageShareData&&e.updateAppMessageShareData({title:i.title,desc:i.content,link:i.url,imgUrl:i.image}),n.updateTimelineShareData&&e.updateTimelineShareData({title:i.title,link:i.url,imgUrl:i.image}),n.onMenuShareWeibo&&e.onMenuShareWeibo({title:i.title,desc:i.content,link:i.url,imgUrl:i.image}),n.onMenuShareAppMessage&&e.onMenuShareAppMessage({title:i.title,desc:i.content,link:i.url,imgUrl:i.image}),n.onMenuShareTimeline&&e.onMenuShareTimeline({title:i.title,link:i.url,imgUrl:i.image})}})})),e.error((function(e){a(e)})),s()}))},y=function(e){return new Promise((function(t,n){window.WeixinJSBridge?window.WeixinJSBridge.invoke("getBrandWCPayRequest",e,(function(e){const{err_msg:i}=e;"get_brand_wcpay_request:ok"==i?t(e):"get_brand_wcpay_request:cancel"!==i&&n(i||"支付失败")})):n("缺少微信环境支持")}))},w=p,$=function(e,t){return p(e,(function(e){t&&t(e);const n=e.search&&"?"!==e.search;o&&!n&&e.hash&&(e.hash=`?${e.hash}`)}))},U="1.3.4";export{h as endAuth,_ as getAuthQuery,f as init,$ as normalizeShareUrl,w as normalizeUrl,y as pay,S as share,d as startAuth,g as startSilentAuth,U as version};
//# sourceMappingURL=wechat.esm.min.js.map
